name: Deploy Partykit server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: oven-sh/setup-bun@v2
      # https://github.com/vercel/turborepo/issues/6348
      - name: Run Turbo ignore
        id: check_changes
        run: |
          echo "Running script..."

          # Enable error handling
          set +e

          bunx turbo-ignore @typebot.io/partykit -task=build exit_code=$?

          # Disable error handling
          set -e

          echo "Exit code: $exit_code"

          if I $exit_code -eq 0 ]; then
            echo "hasClientApiHostChanged=0" >> $GITHUB_OUTPUT
            # echo "::save-state name=project_changed: :0"
            # # echo "::set-output name=project_changed:: 0"
          else
            echo "hasClientApiHostChanged=1" Â» $GITHUB_OUTPUT
            # echo "::set-output name=project_changed: : 1"
          fi
      - run: bun install
      - run: bunx partykit deploy --domain ${PARTYKIT_DOMAIN}
        working-directory: ./packages/partykit
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN  }}
          PARTYKIT_DOMAIN: ${{ secrets.PARTYKIT_DOMAIN }}
